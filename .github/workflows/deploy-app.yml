name: Deploy App Server

on:
  push:
    branches: [dev, main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  # 1ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
  build-frontend:
    runs-on: ubuntu-latest
    name: Build Frontend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: https://api.moviesir.cloud

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # 2ë‹¨ê³„: ì„œë²„ ë°°í¬
  deploy:
    runs-on: ubuntu-latest
    needs: build-frontend
    name: Deploy to App Server

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-dist

      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.APP_HOST }}
          username: ${{ secrets.APP_USER }}
          key: ${{ secrets.SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e

            echo "ðŸ“Œ Fetch latest code"
            cd ~/MovieSir
            git fetch --all
            git reset --hard origin/${{ github.ref_name }}

            echo "ðŸ“Œ Create .env.production"
            cat > .env.production << 'ENVEOF'
            ${{ secrets.ENV_PRODUCTION_APP }}
            ENVEOF

            echo "ðŸ“Œ Stop old containers"
            docker compose --env-file .env.production down || true

            echo "ðŸ“Œ Build & start containers"
            docker compose --env-file .env.production up -d --build

            echo "ðŸ“Œ Cleanup old images"
            docker image prune -f || true

            echo "âœ… Backend deployment complete"

      - name: Deploy Frontend via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.APP_HOST }}
          username: ${{ secrets.APP_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "frontend-dist/*"
          target: "/tmp/frontend-build"
          strip_components: 1

      - name: Move Frontend to Nginx Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.APP_HOST }}
          username: ${{ secrets.APP_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            echo "ðŸ“Œ Deploy frontend to /var/www/demo"
            sudo rm -rf /var/www/demo/*
            sudo cp -r /tmp/frontend-build/* /var/www/demo/
            sudo chown -R www-data:www-data /var/www/demo/
            rm -rf /tmp/frontend-build

            echo "ðŸ“Œ Verify deployment"
            ls -la /var/www/demo/
            echo ""
            echo "ðŸ“Œ New JS file:"
            ls /var/www/demo/assets/ | grep -E "index-.*\.js$" | head -1

            echo "âœ… Frontend deployment complete"
