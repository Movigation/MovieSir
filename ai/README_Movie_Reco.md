# MovieSir 영화 추천 시스템 아키텍처

이 문서는 MovieSir 프로젝트의 AI 영화 추천 시스템이 어떤 로직과 데이터 흐름을 통해 사용자에게 영화를 추천하는지 설명합니다.

---

### 전체 추천 과정 (데이터 흐름)

추천은 프론트엔드-백엔드-AI 서비스 간의 체계적인 통신을 통해 이루어집니다.

1.  **[프론트엔드]** 사용자가 추천 페이지에서 원하는 영화 상영 시간, 장르 등 필터를 선택하고 '추천 받기' 버튼을 누릅니다.

2.  **[백엔드]** 브라우저는 백엔드의 `/api/recommend` API로 `POST` 요청을 보냅니다.
    *   `recommendation/router.py`가 이 요청을 받습니다.

3.  **[백엔드]** `router`는 `recommendation/service.py`의 `get_hybrid_recommendations` 함수를 호출합니다.

4.  **[백엔드]** `service`는 DB에서 사용자가 구독 중인 OTT(Netflix 등) 정보를 조회하고, `recommendation/ai_model.py`에 있는 `AIModelAdapter`의 `predict` 함수를 호출합니다.

5.  **[백엔드]** `AIModelAdapter`는 DB에서 사용자의 영화 시청 기록을 조회한 후, 사용자의 모든 정보(시청 기록, 선호 장르, 구독 OTT 등)를 모아 AI 서비스의 `/recommend` API로 `POST` 요청을 보냅니다.

6.  **[AI 서비스]** `ai/api.py`가 백엔드로부터 온 요청을 받고, 핵심 로직이 담긴 `HybridRecommenderV2` 객체의 `recommend` 함수를 호출합니다.

7.  **[AI 서비스]** **(⭐핵심 로직 실행)** `HybridRecommenderV2`가 두 가지 추천 트랙(`track_a`, `track_b`)을 생성하여 `api.py`로 반환합니다.

8.  **[AI 서비스]** `api.py`는 추천 결과를 백엔드가 처리하기 좋은 형태로 가공하여 응답합니다.

9.  **[백엔드]** `AIModelAdapter`가 AI의 응답에서 추천된 영화들의 ID 목록만 추출하여 `service`로 반환합니다.

10. **[백엔드]** `service`는 AI에게 받은 영화 ID 목록을 이용해 DB에서 각 영화의 제목, 포스터, 줄거리 등 상세 정보를 조회합니다.

11. **[백엔드]** `service`는 상세 정보가 포함된 최종 추천 목록을 `router`로 반환하고, `router`는 이 결과를 브라우저로 전송합니다.

12. **[프론트엔드]** 브라우저는 최종 결과를 받아 화면에 추천 영화 목록을 보여줍니다.

---

### ⭐ 핵심 추천 로직 (`HybridRecommenderV2`)

AI 서비스 내부의 `HybridRecommenderV2`는 **두 가지 추천 알고리즘을 섞은 하이브리드 모델**을 사용합니다.

#### 1. 사용자 프로필 생성

AI는 먼저 사용자가 어떤 사람인지 파악하기 위해 두 종류의 '취향 프로필'을 실시간으로 생성합니다.

*   **SBERT 프로필 (콘텐츠 기반):**
    *   사용자가 본 영화들의 줄거리, 태그 등 **콘텐츠**를 분석한 벡터(SBERT 임베딩)들의 평균을 계산합니다.
    *   **결과:** "이 사용자는 주로 어둡고 철학적인 SF 영화를 좋아하는구나" 와 같이 **콘텐츠 자체**에 기반한 취향 프로필이 생성됩니다.

*   **ALS 프로필 (협업 필터링):**
    *   사용자가 본 영화들을 기반으로, 미리 학습된 ALS 모델을 이용해 **사용자의 잠재 벡터를 역산**합니다 ('Fold-in' 기술).
    *   **결과:** "이 사용자는 다른 사용자 그룹 A와 취향이 매우 비슷하네" 와 같이 **다른 사람들과의 관계**에 기반한 취향 프로필이 생성됩니다.

#### 2. 영화별 점수 계산 및 하이브리드 추천

이제 모든 영화에 대해 두 가지 관점의 점수를 매깁니다.

1.  **SBERT 점수:** 내 SBERT 프로필과 각 영화의 콘텐츠가 얼마나 비슷한가?
2.  **ALS 점수:** 나와 비슷한 취향의 다른 사용자들이 이 영화를 얼마나 좋아했는가?

그 후, 이 두 점수를 **가중 평균**하여 (`SBERT 점수 * 0.7 + ALS 점수 * 0.3`) 최종 **하이브리드 점수**를 계산합니다. 이 점수가 높을수록 사용자에게 더 적합한 영화입니다.

#### 3. 두 가지 추천 트랙 (Track A / Track B)

MovieSir는 단순히 점수 높은 영화만 보여주지 않고, 두 가지 컨셉의 추천 목록을 제공합니다. 각 트랙은 하이브리드 점수를 계산할 때 서로 다른 가중치를 적용하여 추천의 성격을 조절합니다.

*   **Track A (선호 장르 맞춤 추천):**
    *   **목표:** 사용자가 요청한 **필터(장르, OTT 등)를 최대한 만족**시키는 정확도 높은 추천.
    *   **가중치:** `SBERT 70%` + `ALS 30%`. 콘텐츠 기반(SBERT)의 가중치가 높아 사용자의 **기존 취향과 비슷한** 영화를 추천하려는 경향이 강합니다.
    *   **로직:** 계산된 하이브리드 점수가 높은 영화 중에서, 사용자가 선택한 장르/OTT/시간/성인 필터를 모두 통과한 영화들만 보여줍니다.

*   **Track B (장르 확장 추천):**
    *   **목표:** 사용자가 미처 몰랐던 새로운 영화를 발견하게 해주는 **다양성 높은** 추천.
    *   **가중치:** `SBERT 40%` + `ALS 60%`. 협업 필터링(ALS)의 가중치가 높아 **"다른 사람들이 좋아한"** 영화를 더 많이 보여주어 취향을 확장하려는 경향이 강합니다.
    *   **로직:** 장르와 OTT 필터를 **의도적으로 무시**하고 추천을 수행합니다. 이를 통해 "액션 영화를 좋아하지만, 이런 스릴러 영화도 좋아할 것 같네요" 와 같은 제안을 할 수 있습니다.

#### 4. 영화 조합 추천 (Combination Mode)

만약 사용자가 설정한 '이용 가능 시간'이 4시간 이상으로 매우 길다면, '조합 추천 모드'가 활성화됩니다.

*   **로직:** 추천된 영화들을 대상으로, 상영 시간을 모두 더했을 때 사용자의 '이용 가능 시간'과 거의 일치하는 **영화들의 묶음(조합)**을 찾아 제시합니다.
*   **예시:** "4시간 동안 '인터스텔라'와 '그래비티'를 연달아 보는 건 어떠세요?" 와 같은 추천이 가능해집니다.

이 모든 과정을 통해 MovieSir는 사용자의 명시적인 요구사항을 충족시키면서도, 취향을 확장할 수 있는 새로운 발견의 재미까지 제공하는 정교한 추천 결과를 만들어냅니다.
